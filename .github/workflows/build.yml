name: Build and publish
on:
  workflow_dispatch:
  push:
    paths:
      - '.github/latest'
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 1
      matrix:
        ARCH: [ aarch64-musl, x86_64-musl ]
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Set variables
        run: |
          echo "VERSION=`cat .github/latest`" >> $GITHUB_ENV
      - name: Download upstream code
        run: curl -sL https://api.github.com/repos/geph-official/geph4/tarball/refs/tags/${{ env.VERSION }} | tar xvz
      - name: Get source folder
        run: echo "GEPH=`ls | grep geph-official-geph4-`" >> $GITHUB_ENV
      - name: Cross compile
        uses: docker://messense/rust-musl-cross:${{ matrix.ARCH }}
        with:
          args: |
            cargo
            build
            --release
            --locked
            --manifest-path=/github/workspace/${{ env.GEPH }}/Cargo.toml
      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: geph4-client-${{ matrix.ARCH }}
          path: ${{ env.GEPH }}/target/release/geph4-client
  release:
    runs-on: ubuntu-latest
    if: always()
    needs: [ build ]
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Set variables
        run: echo "VERSION=`cat .github/latest`" >> $GITHUB_ENV
      - name: Download artifact
        uses: actions/download-artifact@v2
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ env.VERSION }}
          files: geph4-client-*/geph4-client-*
